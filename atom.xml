<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[David Xia]]></title>
  <link href="https://www.davidxia.com/atom.xml" rel="self"/>
  <link href="https://www.davidxia.com/"/>
  <updated>2020-04-13T13:33:26-04:00</updated>
  <id>https://www.davidxia.com/</id>
  <author>
    <name><![CDATA[David Xia]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[How to Expose a Localhost-only Endpoint on GKE]]></title>
    <link href="https://www.davidxia.com/2020/04/how-to-expose-a-localhost-only-endpoint-on-gke/"/>
    <updated>2020-04-13T12:24:46-04:00</updated>
    <id>https://www.davidxia.com/2020/04/how-to-expose-a-localhost-only-endpoint-on-gke</id>
    <content type="html"><![CDATA[<p>In my <a href="https://www.davidxia.com/2020/04/3-levels-of-load-testing-gke-workload-identity/">previous post</a> I wrote about how to load test GKE Workload Identity. In this post I&rsquo;ll
describe how to get metrics from gke-metadata-server, the part of Workload Identity that runs on
your GKE clusters&#8217; nodes. This solution is a temporary workaround until GKE provides a better way to
get metrics on gke-metadata-server.</p>

<p>Gke-metadata-server runs as a K8s DaemonSet. It exposes metrics about itself in <a href="https://github.com/prometheus/docs/blob/master/content/docs/instrumenting/exposition_formats.md#text-based-format">Prometheus
text-based format</a>. I want to have an external scraper make HTTP requests to periodically collect
these metrics. Unfortunately, the Prometheus HTTP server only listens on the Container&rsquo;s <code>localhost</code>
interface. <strong>So how can we expose these metrics, i.e. make the HTTP endpoint available externally?</strong></p>

<h3>tl;dr lessons learned</h3>

<ul>
<li><code>socat</code> is awesome.</li>
<li>If something you need is running on a computer you control, you can always find a way extract info
from it if you&rsquo;re resourceful enough.</li>
</ul>


<h2>My specific GKE cluster configuration</h2>

<ul>
<li>GKE masters and nodes running version 1.15.9-gke.22</li>
<li>regional cluster in Google Cloud Platform (GCP) (not on-premise)</li>
<li>6 GKE nodes that are n1-standard-32 GCE instances in one node pool</li>
<li>each node is configured to have a maximum of 32 Pods</li>
<li>cluster and node pool have WI enabled</li>
</ul>


<p>Notice the DaemonSet is configured with <code>.spec.template.spec.hostNetwork: true</code> below. This means
the HTTP server is also listening on the GKE node&rsquo;s <code>localhost</code> interface.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">extensions/v1beta1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DaemonSet</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">addonmanager.kubernetes.io/mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Reconcile</span>
</span><span class='line'>    <span class="l-Scalar-Plain">k8s-app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kube-system</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">revisionHistoryLimit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
</span><span class='line'>  <span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">matchLabels</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">k8s-app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">annotations</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">components.gke.io/component-name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server</span>
</span><span class='line'>        <span class="l-Scalar-Plain">components.gke.io/component-version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0.2.21</span>
</span><span class='line'>        <span class="l-Scalar-Plain">scheduler.alpha.kubernetes.io/critical-pod</span><span class="p-Indicator">:</span> <span class="s">&#39;&quot;</span><span class="se">&#39;&#39;</span><span class="s">&quot;&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">creationTimestamp</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">null</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">addonmanager.kubernetes.io/mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Reconcile</span>
</span><span class='line'>        <span class="l-Scalar-Plain">k8s-app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server</span>
</span><span class='line'>    <span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/gke-metadata-server</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">--logtostderr</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">--token-exchange-endpoint=https://securetoken.googleapis.com/v1/identitybindingtoken</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">--identity-namespace=[REDACTED]</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">--identity-provider-id=https://container.googleapis.com/v1/projects/[REDACTED]/locations/europe-west1/clusters/[REDACTED]</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">--passthrough-ksa-list=kube-system:container-watcher-pod-reader,kube-system:event-exporter-sa,kube-system:fluentd-gcp-scaler,kube-system:heapster,kube-system:kube-dns,kube-system:metadata-agent,kube-system:network-metering-agent,kube-system:securityprofile-controller,istio-system:istio-ingressgateway-service-account,istio-system:cluster-local-gateway-service-account,csm:csm-sync-agent,knative-serving:controller</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">--attributes=cluster-name=[REDACTED],cluster-uid=[REDACTED],cluster-location=europe-west1</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">--enable-identity-endpoint=true</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">--cluster-uid=[REDACTED]</span>
</span><span class='line'>        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke.gcr.io/gke-metadata-server:20200218_1145_RC0</span>
</span><span class='line'>        <span class="l-Scalar-Plain">imagePullPolicy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">IfNotPresent</span>
</span><span class='line'>        <span class="l-Scalar-Plain">livenessProbe</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">failureThreshold</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>          <span class="l-Scalar-Plain">httpGet</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">127.0.0.1</span>
</span><span class='line'>            <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/healthz</span>
</span><span class='line'>            <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">54898</span>
</span><span class='line'>            <span class="l-Scalar-Plain">scheme</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">HTTP</span>
</span><span class='line'>          <span class="l-Scalar-Plain">initialDelaySeconds</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
</span><span class='line'>          <span class="l-Scalar-Plain">periodSeconds</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
</span><span class='line'>          <span class="l-Scalar-Plain">successThreshold</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>          <span class="l-Scalar-Plain">timeoutSeconds</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">limits</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">cpu</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100m</span>
</span><span class='line'>            <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100Mi</span>
</span><span class='line'>          <span class="l-Scalar-Plain">requests</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">cpu</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100m</span>
</span><span class='line'>            <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100Mi</span>
</span><span class='line'>        <span class="l-Scalar-Plain">securityContext</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">privileged</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="l-Scalar-Plain">terminationMessagePath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/dev/termination-log</span>
</span><span class='line'>        <span class="l-Scalar-Plain">terminationMessagePolicy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">File</span>
</span><span class='line'>        <span class="l-Scalar-Plain">volumeMounts</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mountPath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/lib/kubelet/kubeconfig</span>
</span><span class='line'>          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kubelet-credentials</span>
</span><span class='line'>          <span class="l-Scalar-Plain">readOnly</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mountPath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/lib/kubelet/pki/</span>
</span><span class='line'>          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kubelet-certs</span>
</span><span class='line'>          <span class="l-Scalar-Plain">readOnly</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mountPath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/run/</span>
</span><span class='line'>          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">container-runtime-interface</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mountPath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/srv/kubernetes/pki</span>
</span><span class='line'>          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kubelet-pki</span>
</span><span class='line'>          <span class="l-Scalar-Plain">readOnly</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mountPath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/ssl/certs/</span>
</span><span class='line'>          <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ca-certificates</span>
</span><span class='line'>          <span class="l-Scalar-Plain">readOnly</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>      <span class="l-Scalar-Plain">dnsPolicy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Default</span>
</span><span class='line'>      <span class="l-Scalar-Plain">hostNetwork</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>      <span class="l-Scalar-Plain">nodeSelector</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">beta.kubernetes.io/os</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>        <span class="l-Scalar-Plain">iam.gke.io/gke-metadata-server-enabled</span><span class="p-Indicator">:</span> <span class="s">&quot;true&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">priorityClassName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">system-node-critical</span>
</span><span class='line'>      <span class="l-Scalar-Plain">restartPolicy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Always</span>
</span><span class='line'>      <span class="l-Scalar-Plain">schedulerName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default-scheduler</span>
</span><span class='line'>      <span class="l-Scalar-Plain">securityContext</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'>      <span class="l-Scalar-Plain">serviceAccount</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server</span>
</span><span class='line'>      <span class="l-Scalar-Plain">serviceAccountName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server</span>
</span><span class='line'>      <span class="l-Scalar-Plain">terminationGracePeriodSeconds</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
</span><span class='line'>      <span class="l-Scalar-Plain">tolerations</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">effect</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">NoExecute</span>
</span><span class='line'>        <span class="l-Scalar-Plain">operator</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Exists</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">effect</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">NoSchedule</span>
</span><span class='line'>        <span class="l-Scalar-Plain">operator</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Exists</span>
</span><span class='line'>      <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostPath</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/lib/kubelet/pki/</span>
</span><span class='line'>          <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Directory</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kubelet-certs</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostPath</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/lib/kubelet/kubeconfig</span>
</span><span class='line'>          <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">File</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kubelet-credentials</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostPath</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/run/</span>
</span><span class='line'>          <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Directory</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">container-runtime-interface</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostPath</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/srv/kubernetes/pki/</span>
</span><span class='line'>          <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Directory</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kubelet-pki</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostPath</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/ssl/certs/</span>
</span><span class='line'>          <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Directory</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ca-certificates</span>
</span><span class='line'>  <span class="l-Scalar-Plain">templateGeneration</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">7</span>
</span><span class='line'>  <span class="l-Scalar-Plain">updateStrategy</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">rollingUpdate</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">maxUnavailable</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">RollingUpdate</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can run a separate workload on this cluster that uses <a href="https://linux.die.net/man/1/socat"><code>socat</code></a> to proxy HTTP requests to
gke-metadata-server. <code>socat</code> stands for socket cat and is a multipurpose relay. It&rsquo;s <code>netcat</code> on
steroids and can relay any kind of packets not just TCP and UDP.</p>

<p>This proxy is deployed as a DaemonSet to make it easy to have a one-to-one
correspondence with each node-local gke-metadata-server Pod. The DaemonSet will also need to have
<code>.spec.template.spec.hostNetwork: true</code> so that it can share the same network namespace.</p>

<p>Here&rsquo;s the proxy DaemonSet YAML. I use the Docker image <a href="https://hub.docker.com/r/alpine/socat/tags"><code>alpine/socat:1.7.3.4-r0</code></a> which is a
tiny 3.61MB. The arguments <code>["TCP-LISTEN:54899,reuseaddr,fork", "TCP:127.0.0.1:54898"]</code> tell socat
to forward traffic from <code>0.0.0.0:54899</code> to <code>127.0.0.1:54898</code> which is where the Prometheus metrics
are. <code>fork</code> tells socat to</p>

<blockquote><p>After establishing a connection, handles its channel in a child process and keeps the parent
process attempting to produce more connections, either by listening or by connecting in a loop</p></blockquote>

<p>&mdash; <a href="http://www.dest-unreach.org/socat/doc/socat.html#OPTION_FORK">http://www.dest-unreach.org/socat/doc/socat.html#OPTION_FORK</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">cat proxy-daemonset.yaml</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apps/v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DaemonSet</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server-metrics-proxy</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">monitoring</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">matchLabels</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server-metrics-proxy</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server-metrics-proxy</span>
</span><span class='line'>    <span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">hostNetwork</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>      <span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server-metrics-proxy</span>
</span><span class='line'>        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine/socat:1.7.3.4-r0@sha256:6786951b55e321e3968ba1c3786cb79b768f85d83d438f085336442b3bcef67a</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;TCP-LISTEN:54899,reuseaddr,fork&quot;</span><span class="p-Indicator">,</span> <span class="s">&quot;TCP:127.0.0.1:54898&quot;</span><span class="p-Indicator">]</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prom-metrics</span>
</span><span class='line'>          <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">54899</span>
</span><span class='line'>          <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">TCP</span>
</span><span class='line'>        <span class="l-Scalar-Plain">livenessProbe</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">httpGet</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">127.0.0.1</span>
</span><span class='line'>            <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/metricz</span>
</span><span class='line'>            <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">54899</span>
</span><span class='line'>            <span class="l-Scalar-Plain">scheme</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">HTTP</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">limits</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">cpu</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100m</span>
</span><span class='line'>            <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100Mi</span>
</span><span class='line'>          <span class="l-Scalar-Plain">requests</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">cpu</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100m</span>
</span><span class='line'>            <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">100Mi</span>
</span></code></pre></td></tr></table></div></figure>


<p>Apply the DaemonSet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">kubectl --context [CONTEXT] apply -f proxy-daemonset.yaml</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now make an HTTP request to any GKE node IP at port 54899.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">kubectl --context [CONTEXT] -n monitoring get pods --selector app=gke-metadata-server-metrics-proxy -o wide</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">NAME                                      READY   STATUS    RESTARTS   AGE     IP              NODE                             NOMINATED NODE   READINESS GATES</span>
</span><span class='line'><span class="l-Scalar-Plain">gke-metadata-server-metrics-proxy-dvlpg   1/1     Running   0          4d19h   10.200.208.6    my-cluster-n1-s-32-dfabe6b6-38px   &lt;none&gt;           &lt;none&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">gke-metadata-server-metrics-proxy-dx4lq   1/1     Running   0          4d19h   10.200.208.8    my-cluster-n1-s-32-dfabe6b6-mnlg   &lt;none&gt;           &lt;none&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">gke-metadata-server-metrics-proxy-j9p49   1/1     Running   0          4d19h   10.200.208.7    my-cluster-n1-s-32-dfabe6b6-vv9s   &lt;none&gt;           &lt;none&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">gke-metadata-server-metrics-proxy-jvvjw   1/1     Running   0          4d19h   10.200.208.12   my-cluster-n1-s-32-192fa3d9-wb2c   &lt;none&gt;           &lt;none&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">gke-metadata-server-metrics-proxy-k5sqd   1/1     Running   0          4d19h   10.200.208.10   my-cluster-n1-s-32-55dd75ff-6l40   &lt;none&gt;           &lt;none&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">gke-metadata-server-metrics-proxy-tdhkn   1/1     Running   0          4d19h   10.200.208.9    my-cluster-n1-s-32-55dd75ff-jqgk   &lt;none&gt;           &lt;none&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">http GET &#39;10.200.208.6:54899/metricz&#39; | head -n 20</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain"># HELP go_gc_duration_seconds A summary of the GC invocation durations.</span>
</span><span class='line'><span class="l-Scalar-Plain"># TYPE go_gc_duration_seconds summary</span>
</span><span class='line'><span class="l-Scalar-Plain">go_gc_duration_seconds{quantile=&quot;0&quot;} 2.8295e-05</span>
</span><span class='line'><span class="l-Scalar-Plain">go_gc_duration_seconds{quantile=&quot;0.25&quot;} 3.6269e-05</span>
</span><span class='line'><span class="l-Scalar-Plain">go_gc_duration_seconds{quantile=&quot;0.5&quot;} 5.2122e-05</span>
</span><span class='line'><span class="l-Scalar-Plain">go_gc_duration_seconds{quantile=&quot;0.75&quot;} 7.585e-05</span>
</span><span class='line'><span class="l-Scalar-Plain">go_gc_duration_seconds{quantile=&quot;1&quot;} 0.099987877</span>
</span><span class='line'><span class="l-Scalar-Plain">go_gc_duration_seconds_sum 7.738486774</span>
</span><span class='line'><span class="l-Scalar-Plain">go_gc_duration_seconds_count 6809</span>
</span><span class='line'><span class="l-Scalar-Plain"># HELP go_goroutines Number of goroutines that currently exist.</span>
</span><span class='line'><span class="l-Scalar-Plain"># TYPE go_goroutines gauge</span>
</span><span class='line'><span class="l-Scalar-Plain">go_goroutines 47</span>
</span><span class='line'><span class="l-Scalar-Plain"># HELP go_info Information about the Go environment.</span>
</span><span class='line'><span class="l-Scalar-Plain"># TYPE go_info gauge</span>
</span><span class='line'><span class="l-Scalar-Plain">go_info{version=&quot;go1.14rc1&quot;} 1</span>
</span><span class='line'><span class="l-Scalar-Plain"># HELP go_memstats_alloc_bytes Number of bytes allocated and still in use.</span>
</span><span class='line'><span class="l-Scalar-Plain"># TYPE go_memstats_alloc_bytes gauge</span>
</span><span class='line'><span class="l-Scalar-Plain">go_memstats_alloc_bytes 2.4743056e+07</span>
</span><span class='line'><span class="l-Scalar-Plain"># HELP go_memstats_alloc_bytes_total Total number of bytes allocated, even if freed.</span>
</span><span class='line'><span class="l-Scalar-Plain"># TYPE go_memstats_alloc_bytes_total counter</span>
</span></code></pre></td></tr></table></div></figure>


<p>Voila. The important metrics are:</p>

<ul>
<li><code>metadata_server_request_count</code></li>
<li><code>metadata_server_request_durations_bucket</code></li>
</ul>


<p>I have these <a href="https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/#recording-rules">Prometheus recording rules</a> to calculate RPS and request
duration percentiles.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">groups</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gke-metadata-server</span>
</span><span class='line'>  <span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="c1"># Compute a 5-minute rate for the counter `metadata_server_request_count`.</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">metadata_server_request_count:rate5m</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rate(metadata_server_request_count[5m])</span>
</span><span class='line'>  <span class="c1"># Compute latency percentiles for the histogram metric</span>
</span><span class='line'>  <span class="c1"># `metadata_server_request_durations_bucket` over 5-minute increments for each label</span>
</span><span class='line'>  <span class="c1"># combination.</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">metadata_server_request_duration:p99</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.99, rate(metadata_server_request_durations_bucket[5m]))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">metadata_server_request_duration:p95</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.95, rate(metadata_server_request_durations_bucket[5m]))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">metadata_server_request_duration:p90</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.90, rate(metadata_server_request_durations_bucket[5m]))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">metadata_server_request_duration:p50</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.50, rate(metadata_server_request_durations_bucket[5m]))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">metadata_server_request_duration:mean</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rate(metadata_server_request_durations_sum[5m]) / rate(metadata_server_request_durations_count[5m])</span>
</span><span class='line'>  <span class="c1"># Compute latency percentiles for the histogram metric</span>
</span><span class='line'>  <span class="c1"># `metadata_server_request_durations_bucket` over 5-minute increments and aggregate all</span>
</span><span class='line'>  <span class="c1"># labels. We must aggregate here instead of in Grafana because averaging percentiles doesn’t</span>
</span><span class='line'>  <span class="c1"># work. To compute a percentile, you need the original population of events. The math is just</span>
</span><span class='line'>  <span class="c1"># broken. An average of a percentile is meaningless.</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">metadata_server_all_request_duration:p99</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.99, sum(rate(metadata_server_request_durations_bucket[5m])) by (le))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">metadata_server_all_request_duration:p95</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.95, sum(rate(metadata_server_request_durations_bucket[5m])) by (le))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">metadata_server_all_request_duration:p90</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.90, sum(rate(metadata_server_request_durations_bucket[5m])) by (le))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">metadata_server_all_request_duration:p50</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.50, sum(rate(metadata_server_request_durations_bucket[5m])) by (le))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">metadata_server_all_request_duration:mean</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rate(metadata_server_request_durations_sum[5m]) / rate(metadata_server_request_durations_count[5m])</span>
</span><span class='line'>  <span class="c1"># Compute latency percentiles for the histogram metric `outgoing_request_latency_bucket` over</span>
</span><span class='line'>  <span class="c1"># 5-minute increments for each label combination.</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">outgoing_request_latency:p99</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.99, rate(outgoing_request_latency_bucket[5m]))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">outgoing_request_latency:p95</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.95, rate(outgoing_request_latency_bucket[5m]))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">outgoing_request_latency:p90</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.90, rate(outgoing_request_latency_bucket[5m]))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">outgoing_request_latency:p50</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.50, rate(outgoing_request_latency_bucket[5m]))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">outgoing_request_latency:mean</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rate(outgoing_request_latency_sum[5m]) / rate(outgoing_request_latency_count[5m])</span>
</span><span class='line'>  <span class="c1"># Compute latency percentiles for the histogram metric `outgoing_request_latency_bucket` over</span>
</span><span class='line'>  <span class="c1"># 5-minute increments and aggregate all labels. We must aggregate here instead of in Grafana</span>
</span><span class='line'>  <span class="c1"># because averaging percentiles doesn’t work. To compute a percentile, you need the original</span>
</span><span class='line'>  <span class="c1"># population of events. The math is just broken. An average of a percentile is meaningless.</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">outgoing_all_request_latency:p99</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.99, sum(rate(outgoing_request_latency_bucket[5m])) by (le))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">outgoing_all_request_latency:p95</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.95, sum(rate(outgoing_request_latency_bucket[5m])) by (le))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">outgoing_all_request_latency:p90</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.90, sum(rate(outgoing_request_latency_bucket[5m])) by (le))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">outgoing_all_request_latency:p50</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">histogram_quantile(0.50, sum(rate(outgoing_request_latency_bucket[5m])) by (le))</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">record</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">outgoing_all_request_latency:mean</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rate(outgoing_request_latency_sum[5m]) / rate(outgoing_request_latency_count[5m])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thanks to <a href="https://twitter.com/mikedanese">@mikedanese</a> for the intial idea of using <code>socat</code>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[3 Levels of Load Testing GKE Workload Identity]]></title>
    <link href="https://www.davidxia.com/2020/04/3-levels-of-load-testing-gke-workload-identity/"/>
    <updated>2020-04-01T10:21:11-04:00</updated>
    <id>https://www.davidxia.com/2020/04/3-levels-of-load-testing-gke-workload-identity</id>
    <content type="html"><![CDATA[<p>I manage multitenant <a href="https://cloud.google.com/kubernetes-engine">Google Kubernetes Engine</a> (GKE) clusters for stateless backend services at
work. Google recently graduated GKE&rsquo;s <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity">Workload Identity</a> (WI) feature to generally available
(GA). When my team used WI during its beta stage, it seemed to fail when there were more than 16
requests per second (RPS) on one GKE node to retrieve Google access tokens.</p>

<p>Before we knew about this low RPS failure threshold, we told many internal engineering teams
to go ahead and use the feature. In hindsight, we should&rsquo;ve load-tested the feature before making it
generally available internally especially since it wasn&rsquo;t even GA publicly.</p>

<p>My efforts to load test WI have grown more sophisticated over time. This post describes the
progression. It&rsquo;s like the &ldquo;4 Levels of &hellip;&rdquo; <a href="https://www.youtube.com/playlist?list=PLz3-p2q6vFYUDvVUu_aPhGUV-3ROIa6d2">Epicurious Youtube videos</a>. The goal here is to find
out at what RPS WI starts to fail and to try to learn some generalizable lessons from load testing
vendor-managed services.</p>

<h3>tl;dr lessons learned</h3>

<ul>
<li>always load test new features above and beyond what you expect your production load will be</li>
<li>use proper load testing tools and not bash for loops</li>
</ul>


<h2>My specific GKE cluster configuration</h2>

<ul>
<li>GKE masters and nodes running version 1.15.9-gke.22</li>
<li>regional cluster in Google Cloud Platform (GCP) (not on-premise)</li>
<li>4 GKE nodes that are n1-standard-32 GCE instances in one node pool</li>
<li>each node is configured to have a maximum of 32 Pods</li>
<li>cluster and node pool have WI enabled</li>
</ul>


<h2>High level of what Workload Identity is and how it works</h2>

<p>Workloads on GKE often need to access GCP resources like PubSub or CloudSQL.
In order to do so, your workload needs to use a Google Service Account (GSA) key that is authorized to
access those resources. So you end up creating keys for all your GSA&rsquo;s and copy-pasting
these keys into Kubernetes Secrets for your workloads. This is insecure and not maintainable if you
are a company that has dozens of engineering teams and hundreds of workloads.</p>

<p>So GCP offered WI which allows a Kubernetes Service Account (KSA) to be associated with a GSA. If a
workload can run with a certain KSA, it&rsquo;ll transparently get the Google access token for the
associated GSA. No manual copy-pasting GSA keys!</p>

<p>How does this work? You have to enable WI on your cluster and node pool. This creates a
<code>gke-metadata-server</code> DaemonSet in the <code>kube-system</code> namespace. <code>gke-metadata-server</code> is the
entrypoint to the whole WI system. Here&rsquo;s a nice <a href="https://www.youtube.com/watch?v=s4NYEJDFc0M">Google Cloud Next conference talk</a> with more
details.</p>

<p><code>gke-metadata-server</code> is the only part of WI that is exposed to GKE users, i.e. runs on machines you
control. It&rsquo;s like the Verizon FiOS box in your basement. You control your house, but there&rsquo;s a
little box that Verizon owns and operates in there. All other parts of WI run on GCP infrastructure
that you can&rsquo;t see. When I saw failures with WI, it all seemed to happen in
<code>gke-metadata-server</code>. So that&rsquo;s what I&rsquo;ll load test.</p>

<p>Here&rsquo;s the <code>gke-metadata-server</code> DaemonSet YAML for reference. As of the time of this writing the
image is <code>gke.gcr.io/gke-metadata-server:20200218_1145_RC0</code>. You might see different behavior with
different images.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apiVersion: extensions/v1beta1
</span><span class='line'>kind: DaemonSet
</span><span class='line'>metadata:
</span><span class='line'>  creationTimestamp: "2019-10-15T17:04:40Z"
</span><span class='line'>  generation: 8
</span><span class='line'>  labels:
</span><span class='line'>    addonmanager.kubernetes.io/mode: Reconcile
</span><span class='line'>    k8s-app: gke-metadata-server
</span><span class='line'>  name: gke-metadata-server
</span><span class='line'>  namespace: kube-system
</span><span class='line'>  resourceVersion: "138588210"
</span><span class='line'>  selfLink: /apis/extensions/v1beta1/namespaces/kube-system/daemonsets/gke-metadata-server
</span><span class='line'>  uid: e06885d8-ef6d-11e9-88c9-42010a8c0110
</span><span class='line'>spec:
</span><span class='line'>  revisionHistoryLimit: 10
</span><span class='line'>  selector:
</span><span class='line'>    matchLabels:
</span><span class='line'>      k8s-app: gke-metadata-server
</span><span class='line'>  template:
</span><span class='line'>    metadata:
</span><span class='line'>      annotations:
</span><span class='line'>        components.gke.io/component-name: gke-metadata-server
</span><span class='line'>        components.gke.io/component-version: 0.2.21
</span><span class='line'>        scheduler.alpha.kubernetes.io/critical-pod: '"''"'
</span><span class='line'>      creationTimestamp: null
</span><span class='line'>      labels:
</span><span class='line'>        addonmanager.kubernetes.io/mode: Reconcile
</span><span class='line'>        k8s-app: gke-metadata-server
</span><span class='line'>    spec:
</span><span class='line'>      containers:
</span><span class='line'>      - command:
</span><span class='line'>        - /gke-metadata-server
</span><span class='line'>        - --logtostderr
</span><span class='line'>        - --token-exchange-endpoint=https://securetoken.googleapis.com/v1/identitybindingtoken
</span><span class='line'>        - --identity-namespace=[redacted].svc.id.goog
</span><span class='line'>        - --identity-provider-id=https://container.googleapis.com/v1/projects/[redacted]/locations/asia-east1/clusters/[redacted]
</span><span class='line'>        - --passthrough-ksa-list=kube-system:container-watcher-pod-reader,kube-system:event-exporter-sa,kube-system:fluentd-gcp-scaler,kube-system:heapster,kube-system:kube-dns,kube-system:metadata-agent,kube-system:network-metering-agent,kube-system:securityprofile-controller,istio-system:istio-ingressgateway-service-account,istio-system:cluster-local-gateway-service-account,csm:csm-sync-agent,knative-serving:controller
</span><span class='line'>        - --attributes=cluster-name=[redacted],cluster-uid=[redacted],cluster-location=asia-east1
</span><span class='line'>        - --enable-identity-endpoint=true
</span><span class='line'>        - --cluster-uid=[redacted]
</span><span class='line'>        image: gke.gcr.io/gke-metadata-server:20200218_1145_RC0
</span><span class='line'>        imagePullPolicy: IfNotPresent
</span><span class='line'>        livenessProbe:
</span><span class='line'>          failureThreshold: 3
</span><span class='line'>          httpGet:
</span><span class='line'>            host: 127.0.0.1
</span><span class='line'>            path: /healthz
</span><span class='line'>            port: 54898
</span><span class='line'>            scheme: HTTP
</span><span class='line'>          initialDelaySeconds: 10
</span><span class='line'>          periodSeconds: 10
</span><span class='line'>          successThreshold: 1
</span><span class='line'>          timeoutSeconds: 1
</span><span class='line'>        name: gke-metadata-server
</span><span class='line'>        resources:
</span><span class='line'>          limits:
</span><span class='line'>            cpu: 100m
</span><span class='line'>            memory: 100Mi
</span><span class='line'>          requests:
</span><span class='line'>            cpu: 100m
</span><span class='line'>            memory: 100Mi
</span><span class='line'>        securityContext:
</span><span class='line'>          privileged: true
</span><span class='line'>        terminationMessagePath: /dev/termination-log
</span><span class='line'>        terminationMessagePolicy: File
</span><span class='line'>        volumeMounts:
</span><span class='line'>        - mountPath: /var/lib/kubelet/kubeconfig
</span><span class='line'>          name: kubelet-credentials
</span><span class='line'>          readOnly: true
</span><span class='line'>        - mountPath: /var/lib/kubelet/pki/
</span><span class='line'>          name: kubelet-certs
</span><span class='line'>          readOnly: true
</span><span class='line'>        - mountPath: /var/run/
</span><span class='line'>          name: container-runtime-interface
</span><span class='line'>        - mountPath: /etc/srv/kubernetes/pki
</span><span class='line'>          name: kubelet-pki
</span><span class='line'>          readOnly: true
</span><span class='line'>        - mountPath: /etc/ssl/certs/
</span><span class='line'>          name: ca-certificates
</span><span class='line'>          readOnly: true
</span><span class='line'>      dnsPolicy: Default
</span><span class='line'>      hostNetwork: true
</span><span class='line'>      nodeSelector:
</span><span class='line'>        beta.kubernetes.io/os: linux
</span><span class='line'>        iam.gke.io/gke-metadata-server-enabled: "true"
</span><span class='line'>      priorityClassName: system-node-critical
</span><span class='line'>      restartPolicy: Always
</span><span class='line'>      schedulerName: default-scheduler
</span><span class='line'>      securityContext: {}
</span><span class='line'>      serviceAccount: gke-metadata-server
</span><span class='line'>      serviceAccountName: gke-metadata-server
</span><span class='line'>      terminationGracePeriodSeconds: 30
</span><span class='line'>      tolerations:
</span><span class='line'>      - effect: NoExecute
</span><span class='line'>        operator: Exists
</span><span class='line'>      - effect: NoSchedule
</span><span class='line'>        operator: Exists
</span><span class='line'>      volumes:
</span><span class='line'>      - hostPath:
</span><span class='line'>          path: /var/lib/kubelet/pki/
</span><span class='line'>          type: Directory
</span><span class='line'>        name: kubelet-certs
</span><span class='line'>      - hostPath:
</span><span class='line'>          path: /var/lib/kubelet/kubeconfig
</span><span class='line'>          type: File
</span><span class='line'>        name: kubelet-credentials
</span><span class='line'>      - hostPath:
</span><span class='line'>          path: /var/run/
</span><span class='line'>          type: Directory
</span><span class='line'>        name: container-runtime-interface
</span><span class='line'>      - hostPath:
</span><span class='line'>          path: /etc/srv/kubernetes/pki/
</span><span class='line'>          type: Directory
</span><span class='line'>        name: kubelet-pki
</span><span class='line'>      - hostPath:
</span><span class='line'>          path: /etc/ssl/certs/
</span><span class='line'>          type: Directory
</span><span class='line'>        name: ca-certificates
</span><span class='line'>  templateGeneration: 8
</span><span class='line'>  updateStrategy:
</span><span class='line'>    rollingUpdate:
</span><span class='line'>      maxUnavailable: 1
</span><span class='line'>    type: RollingUpdate</span></code></pre></td></tr></table></div></figure>


<h2>Level 1</h2>

<p>What kind of load am I putting on <code>gke-metadata-server</code>? Since this DaemonSet exists to give out
Google access tokens, I&rsquo;ll send it HTTP requests asking for such tokens.</p>

<p>I built a Docker image with the following <code>Dockerfile</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FROM google/cloud-sdk
</span><span class='line'>ENTRYPOINT while true; do for i in {1..20}; do curl -X GET https://www.googleapis.com/oauth2/v3/tokeninfo?access_token=$(gcloud auth print-access-token) & done; wait; done;</span></code></pre></td></tr></table></div></figure>


<p>Then I created the following K8s Deployment YAML.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apps/v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deployment</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wi-test</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">K8S_NAMESPACE</span><span class="p-Indicator">]</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">7</span>
</span><span class='line'>  <span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">matchLabels</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wi-test</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wi-test</span>
</span><span class='line'>    <span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">nodeSelector</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">kubernetes.io/hostname</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">NODE-NAME</span><span class="p-Indicator">]</span>
</span><span class='line'>      <span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-docker-image</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">workload-identity-test</span>
</span></code></pre></td></tr></table></div></figure>


<p>I ran seven of these Pods on a single node (see the <code>nodeSelector</code> above) to target a single
instance of <code>gke-metadata-server</code>.</p>

<p>This isn&rsquo;t a great test because there&rsquo;s a lot of extra work performed by the Container in running
<code>gcloud</code> to print a Google access token (there may be bottlenecks in this <code>gcloud</code> command itself
which is Python code), curling the <code>googleapis.com</code> endpoint to get the token info (originally done
to verify the token was valid). And there&rsquo;s probably bottlenecks in using a shell to do this. All in
all, this implementation doesn&rsquo;t really let you specify a fixed RPS. You&rsquo;re at the mercy of how fast
your Container, shell, gcloud, and the network will let you execute this. I also wasn&rsquo;t able to run
more Pods on a single node because I was hitting the max 32 pods per node limit. There were already
a bunch of other GKE-system level workloads like Calico that took up node capacity.</p>

<h2>Level 2</h2>

<p>Apply this one Pod</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">cat &lt;&lt;EOF | kubectl --context [CONTEXT] apply -f -</span>
</span><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Pod</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wi-test</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">K8S_NAMESPACE</span><span class="p-Indicator">]</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">google/cloud-sdk</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wi-test</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="s">&#39;/bin/bash&#39;</span><span class="p-Indicator">,</span> <span class="s">&#39;-c&#39;</span><span class="p-Indicator">,</span> <span class="s">&#39;--&#39;</span> <span class="p-Indicator">]</span>
</span><span class='line'>    <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span> <span class="s">&#39;while</span><span class="nv"> </span><span class="s">true;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">30;</span><span class="nv"> </span><span class="s">done;&#39;</span> <span class="p-Indicator">]</span>
</span><span class='line'>    <span class="l-Scalar-Plain">securityContext</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">allowPrivilegeEscalation</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>      <span class="l-Scalar-Plain">privileged</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>      <span class="l-Scalar-Plain">readOnlyRootFilesystem</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">limits</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">cpu</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>        <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4G</span>
</span><span class='line'>      <span class="l-Scalar-Plain">requests</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">cpu</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>        <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4G</span>
</span><span class='line'><span class="l-Scalar-Plain">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then <code>kubectl exec</code> in and run this command.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">for i in {1..N}; do gcloud auth print-access-token &amp; done; wait;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Everything seemed to work fine when N was 100. When N was 200 I got a few errors like the below.
They look like client-side errors and not server ones though.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">ERROR</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gcloud failed to load</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">No module named &#39;ruamel.yaml.error&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">gcloud_main = _import_gcloud_main()</span>
</span><span class='line'><span class="l-Scalar-Plain">import googlecloudsdk.gcloud_main</span>
</span><span class='line'><span class="l-Scalar-Plain">from googlecloudsdk.api_lib.iamcredentials import util as iamcred_util</span>
</span><span class='line'><span class="l-Scalar-Plain">from googlecloudsdk.api_lib.util import exceptions</span>
</span><span class='line'><span class="l-Scalar-Plain">from googlecloudsdk.core.resource import resource_printer</span>
</span><span class='line'><span class="l-Scalar-Plain">from googlecloudsdk.core.resource import yaml_printer</span>
</span><span class='line'><span class="l-Scalar-Plain">from googlecloudsdk.core.yaml import dict_like</span>
</span><span class='line'><span class="l-Scalar-Plain">from googlecloudsdk.core import yaml_location_value</span>
</span><span class='line'><span class="l-Scalar-Plain">from ruamel import yaml</span>
</span><span class='line'><span class="l-Scalar-Plain">from ruamel.yaml.main import *</span> <span class="c1"># NOQA</span>
</span><span class='line'><span class="l-Scalar-Plain">from ruamel.yaml.error import UnsafeLoaderWarning, YAMLError</span> <span class="c1"># NOQA</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">This usually indicates corruption in your gcloud installation or problems with your Python interpreter.</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Please verify that the following is the path to a working Python 2.7 or 3.5+ executable</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">/usr/bin/python3</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">If it is not, please set the CLOUDSDK_PYTHON environment variable to point to a working Python 2.7 or 3.5+ executable.</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">If you are still experiencing problems, please reinstall the Cloud SDK using the instructions here</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">https://cloud.google.com/sdk/</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">ERROR</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gcloud failed to load</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cannot import name &#39;opentype&#39; from &#39;pyasn1.type&#39; (/usr/bin/../lib/google-cloud-sdk/lib/third_party/pyasn1/type/__init__.py)</span>
</span><span class='line'><span class="l-Scalar-Plain">from google.auth.crypt import _cryptography_rsa</span>
</span><span class='line'><span class="l-Scalar-Plain">import cryptography.exceptions</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">File &quot;/usr/bin/../lib/google-cloud-sdk/lib/gcloud.py&quot;, line 67, in main</span>
</span><span class='line'><span class="l-Scalar-Plain">File &quot;/usr/bin/../lib/google-cloud-sdk/lib/gcloud.py&quot;, line 48, in _import_gcloud_main</span>
</span><span class='line'><span class="l-Scalar-Plain">File &quot;/usr/lib/google-cloud-sdk/lib/googlecloudsdk/gcloud_main.py&quot;, line 33, in &lt;module&gt;</span>
</span><span class='line'><span class="l-Scalar-Plain">File &quot;/usr/lib/google-cloud-sdk/lib/googlecloudsdk/api_lib</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>gcloud</code> does not synchronize between processes with concurrent invokations. It sometimes writes
files to disk. So this is also not a great load test because it still doesn&rsquo;t let you achieve a
specific RPS and has client-side bottlenecks.</p>

<h2>Level 3</h2>

<p>Use a proper HTTP load testing tool. A colleague told me about <a href="https://github.com/tsenart/vegeta"><code>vegeta</code></a>.
It&rsquo;s a seemingly good tool, but, more importantly, its commands are amazing.
<code>vegeta attack ...</code>.</p>

<p>I first start a <code>golang</code> Pod that just busy-waits.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ cat &lt;&lt;EOF | kubectl --context [CONTEXT] apply -f -</span>
</span><span class='line'><span class="l-Scalar-Plain">&gt; apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err"> kind: Pod</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err"> metadata:</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">   name: wi-test</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">   namespace: [NAMESPACE]</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err"> spec:</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">   containers:</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">   - image: golang:latest</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">     name: wi-test</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">     command: [ &#39;/bin/bash&#39;, &#39;-c&#39;, &#39;--&#39; ]</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">     args: [ &#39;while true; do sleep 30; done;&#39; ]</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">     resources:</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">       limits:</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">         cpu: 2</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">         memory: 4G</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">       requests:</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">         cpu: 2</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err">         memory: 4G</span>
</span><span class='line'><span class="p-Indicator">&gt;</span><span class="err"> EOF</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">pod/wi-test created</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I get a shell in it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">kubectl --context [CONTEXT] -n [NAMESPACE] exec -it wi-test bash</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Defaulting container name to wi-test.</span>
</span><span class='line'><span class="l-Scalar-Plain">Use &#39;kubectl describe pod/wi-test -n [NAMESPACE]&#39; to see all of the containers in this pod.</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">root@wi-test:/go# go get github.com/tsenart/vegeta</span>
</span><span class='line'><span class="l-Scalar-Plain">root@wi-test:/go# vegeta -version</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Version</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">Commit</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">Runtime</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">go1.14.1 linux/amd64</span>
</span><span class='line'><span class="l-Scalar-Plain">Date</span><span class="p-Indicator">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s throw some load on WI! <code>my-gsa@my-project.iam.gserviceaccount.com</code> is the GSA associated with
the KSA your workload runs as.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">root@wi-test:/go# echo &quot;GET http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot; | vegeta attack -header &#39;Metadata-Flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Google&#39; -rate 10 -duration=5s | vegeta report</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Requests      [total, rate, throughput]         50, 10.20, 10.20</span>
</span><span class='line'><span class="l-Scalar-Plain">Duration      [total, attack, wait]             4.904s, 4.9s, 4.168ms</span>
</span><span class='line'><span class="l-Scalar-Plain">Latencies     [min, mean, 50, 90, 95, 99, max]  4.168ms, 6.137ms, 5.039ms, 9.591ms, 10.444ms, 31.452ms, 31.452ms</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes In      [total, mean]                     25300, 506.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes Out     [total, mean]                     0, 0.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Success       [ratio]                           100.00%</span>
</span><span class='line'><span class="l-Scalar-Plain">Status Codes  [code:count]                      200:50</span>
</span><span class='line'><span class="l-Scalar-Plain">Error Set</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">root@wi-test:/go# echo &quot;GET http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot; | vegeta attack -header &#39;Metadata-Flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Google&#39; -rate 1000 -duration=5s | vegeta report</span>
</span><span class='line'><span class="l-Scalar-Plain">Requests      [total, rate, throughput]         5000, 1000.20, 127.51</span>
</span><span class='line'><span class="l-Scalar-Plain">Duration      [total, attack, wait]             31.175s, 4.999s, 26.176s</span>
</span><span class='line'><span class="l-Scalar-Plain">Latencies     [min, mean, 50, 90, 95, 99, max]  101.972ms, 11.003s, 7.652s, 30s, 30s, 30s, 30.001s</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes In      [total, mean]                     2011350, 402.27</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes Out     [total, mean]                     0, 0.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Success       [ratio]                           79.50%</span>
</span><span class='line'><span class="l-Scalar-Plain">Status Codes  [code:count]                      0:1025  200:3975</span>
</span><span class='line'><span class="l-Scalar-Plain">Error Set</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">Get &quot;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">context deadline exceeded (Client.Timeout exceeded while awaiting headers)</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">root@wi-test:/go# echo &quot;GET http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot; | vegeta attack -header &#39;Metadata-Flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Google&#39; -rate 100 -duration=5s | vegeta report</span>
</span><span class='line'><span class="l-Scalar-Plain">Requests      [total, rate, throughput]         500, 100.20, 98.40</span>
</span><span class='line'><span class="l-Scalar-Plain">Duration      [total, attack, wait]             5.081s, 4.99s, 91.244ms</span>
</span><span class='line'><span class="l-Scalar-Plain">Latencies     [min, mean, 50, 90, 95, 99, max]  3.805ms, 106.449ms, 59.058ms, 306.334ms, 372.519ms, 506.703ms, 601.534ms</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes In      [total, mean]                     253000, 506.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes Out     [total, mean]                     0, 0.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Success       [ratio]                           100.00%</span>
</span><span class='line'><span class="l-Scalar-Plain">Status Codes  [code:count]                      200:500</span>
</span><span class='line'><span class="l-Scalar-Plain">Error Set</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">root@wi-test:/go# echo &quot;GET http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot; | vegeta attack -header &#39;Metadata-Flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Google&#39; -rate 500 -duration=5s | vegeta report</span>
</span><span class='line'><span class="l-Scalar-Plain">Requests      [total, rate, throughput]         2500, 500.20, 43.29</span>
</span><span class='line'><span class="l-Scalar-Plain">Duration      [total, attack, wait]             34.072s, 4.998s, 29.074s</span>
</span><span class='line'><span class="l-Scalar-Plain">Latencies     [min, mean, 50, 90, 95, 99, max]  10.56ms, 12.579s, 756.03ms, 30s, 30s, 30s, 30.001s</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes In      [total, mean]                     746350, 298.54</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes Out     [total, mean]                     0, 0.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Success       [ratio]                           59.00%</span>
</span><span class='line'><span class="l-Scalar-Plain">Status Codes  [code:count]                      0:1025  200:1475</span>
</span><span class='line'><span class="l-Scalar-Plain">Error Set</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">Get &quot;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">context deadline exceeded (Client.Timeout exceeded while awaiting headers)</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">root@wi-test:/go# echo &quot;GET http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot; | vegeta attack -header &#39;Metadata-Flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Google&#39; -rate 250 -duration=5s | vegeta report</span>
</span><span class='line'><span class="l-Scalar-Plain">Requests      [total, rate, throughput]         1250, 250.22, 28.52</span>
</span><span class='line'><span class="l-Scalar-Plain">Duration      [total, attack, wait]             34.996s, 4.996s, 30s</span>
</span><span class='line'><span class="l-Scalar-Plain">Latencies     [min, mean, 50, 90, 95, 99, max]  8.331ms, 6.347s, 376.419ms, 30s, 30s, 30s, 30.001s</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes In      [total, mean]                     504988, 403.99</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes Out     [total, mean]                     0, 0.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Success       [ratio]                           79.84%</span>
</span><span class='line'><span class="l-Scalar-Plain">Status Codes  [code:count]                      0:252  200:998</span>
</span><span class='line'><span class="l-Scalar-Plain">Error Set</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">Get &quot;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">context deadline exceeded (Client.Timeout exceeded while awaiting headers)</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">root@wi-test:/go# echo &quot;GET http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot; | vegeta attack -header &#39;Metadata-Flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Google&#39; -rate 200 -duration=5s | vegeta report</span>
</span><span class='line'><span class="l-Scalar-Plain">Requests      [total, rate, throughput]         1000, 200.20, 28.28</span>
</span><span class='line'><span class="l-Scalar-Plain">Duration      [total, attack, wait]             32.43s, 4.995s, 27.435s</span>
</span><span class='line'><span class="l-Scalar-Plain">Latencies     [min, mean, 50, 90, 95, 99, max]  9.985ms, 2.739s, 188.509ms, 797.058ms, 30s, 30s, 30s</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes In      [total, mean]                     464002, 464.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes Out     [total, mean]                     0, 0.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Success       [ratio]                           91.70%</span>
</span><span class='line'><span class="l-Scalar-Plain">Status Codes  [code:count]                      0:83  200:917</span>
</span><span class='line'><span class="l-Scalar-Plain">Error Set</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">Get &quot;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">context deadline exceeded (Client.Timeout exceeded while awaiting headers)</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">root@wi-test:/go# echo &quot;GET http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot; | vegeta attack -header &#39;Metadata-Flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Google&#39; -rate 150 -duration=5s | vegeta report</span>
</span><span class='line'><span class="l-Scalar-Plain">Requests      [total, rate, throughput]         750, 150.20, 146.53</span>
</span><span class='line'><span class="l-Scalar-Plain">Duration      [total, attack, wait]             5.118s, 4.993s, 125.078ms</span>
</span><span class='line'><span class="l-Scalar-Plain">Latencies     [min, mean, 50, 90, 95, 99, max]  3.747ms, 224.285ms, 171.325ms, 460.236ms, 549.18ms, 682.161ms, 892.25ms</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes In      [total, mean]                     379500, 506.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes Out     [total, mean]                     0, 0.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Success       [ratio]                           100.00%</span>
</span><span class='line'><span class="l-Scalar-Plain">Status Codes  [code:count]                      200:750</span>
</span><span class='line'><span class="l-Scalar-Plain">Error Set</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">root@wi-test:/go# echo &quot;GET http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot; | vegeta attack -header &#39;Metadata-Flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Google&#39; -rate 175 -duration=5s | vegeta report</span>
</span><span class='line'><span class="l-Scalar-Plain">Requests      [total, rate, throughput]         875, 175.20, 24.46</span>
</span><span class='line'><span class="l-Scalar-Plain">Duration      [total, attack, wait]             34.097s, 4.994s, 29.103s</span>
</span><span class='line'><span class="l-Scalar-Plain">Latencies     [min, mean, 50, 90, 95, 99, max]  3.704ms, 1.687s, 231.652ms, 708.672ms, 2.432s, 30s, 30s</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes In      [total, mean]                     422004, 482.29</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes Out     [total, mean]                     0, 0.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Success       [ratio]                           95.31%</span>
</span><span class='line'><span class="l-Scalar-Plain">Status Codes  [code:count]                      0:41  200:834</span>
</span><span class='line'><span class="l-Scalar-Plain">Error Set</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">Get &quot;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">context deadline exceeded (Client.Timeout exceeded while awaiting headers)</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">root@wi-test:/go# echo &quot;GET http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot; | vegeta attack -header &#39;Metadata-Flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Google&#39; -rate 165 -duration=5s | vegeta report</span>
</span><span class='line'><span class="l-Scalar-Plain">Requests      [total, rate, throughput]         825, 165.20, 23.61</span>
</span><span class='line'><span class="l-Scalar-Plain">Duration      [total, attack, wait]             34.6s, 4.994s, 29.606s</span>
</span><span class='line'><span class="l-Scalar-Plain">Latencies     [min, mean, 50, 90, 95, 99, max]  3.483ms, 558.613ms, 222.111ms, 531.49ms, 622.473ms, 11.851s, 30s</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes In      [total, mean]                     413402, 501.09</span>
</span><span class='line'><span class="l-Scalar-Plain">Bytes Out     [total, mean]                     0, 0.00</span>
</span><span class='line'><span class="l-Scalar-Plain">Success       [ratio]                           99.03%</span>
</span><span class='line'><span class="l-Scalar-Plain">Status Codes  [code:count]                      0:8  200:817</span>
</span><span class='line'><span class="l-Scalar-Plain">Error Set</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">Get &quot;http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/my-gsa@my-project.iam.gserviceaccount.com/token&quot;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">context deadline exceeded (Client.Timeout exceeded while awaiting headers)</span>
</span></code></pre></td></tr></table></div></figure>


<p>After more bisection, I found that this specific instance of <code>gke-metadata-server</code>
starts to fail around 150RPS. When it does fail, p99 latency skyrockets from less than 1 second to
30 seconds. This is usually a sign of a rate limiter or quota.</p>

<p>How have you tried load testing WI or other GKE features? What&rsquo;re your favorite load testing tools
for these cases, and what interesting behavior have you found?</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Becoming a Better Public Speaker]]></title>
    <link href="https://www.davidxia.com/2019/05/becoming-a-better-public-speaker/"/>
    <updated>2019-05-26T00:04:59+02:00</updated>
    <id>https://www.davidxia.com/2019/05/becoming-a-better-public-speaker</id>
    <content type="html"><![CDATA[<p>At the beginning of this year I set a goal of becoming a better public speaker
and more visible in both tech and other broader causes I believe in. I&rsquo;m happy
to say that in the last two months I gave three talks! Two were prepared talks
with slides at tech conferences. The other was an unprepared conversation on a
podcast. These were all technical and related to my work at Spotify. Outside
of Spotify, I spoke for one minute at a mock political town hall in front of
about 30 people and at a public policy forum for ~15 minutes in front of
roughly the same number of people. But more on that later. Here are my
technical talks. These talks wouldn&rsquo;t be possible without the help, feedback,
and moral support from my Spotify colleagues.</p>

<h2>1. Keynote at KubeCon + CloudNativeCon Europe 2019 in Barcelona on May 22, 2019</h2>

<p><a href="https://kccnceu19.sched.com/event/MQbb/keynote-how-spotify-accidentally-deleted-all-its-kube-clusters-with-no-user-impact-david-xia-infrastructure-engineer-spotify">&ldquo;How Spotify Accidentally Deleted All its Kube Clusters with No User Impact&rdquo;</a></p>

<iframe width="750" height="422" src="https://www.youtube.com/embed/ix0Tw8uinWs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


<h2>2. Kubernetes Podcast from Google on April 23, 2019</h2>

<p><a href="https://kubernetespodcast.com/episode/050-spotify/">&ldquo;Spotify, with David Xia&rdquo;</a>. Listen on <a href="https://open.spotify.com/show/0AsnxlMtXRUEeZkIO0ScpJ">Spotify here</a>.</p>

<h2>3. Joint talk with Google at Google Next SF on April 11, 2019</h2>

<p><a href="https://cloud.withgoogle.com/next/sf/sessions?session=HYB316">&ldquo;GKE Usage Metering: Whose Line Item Is It Anyway?&rdquo;</a></p>

<iframe width="750" height="422" src="https://www.youtube.com/embed/EuBc1v27hY8?start=1036" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[More About Nginx DNS Resolution Than You Ever Wanted to Know]]></title>
    <link href="https://www.davidxia.com/2019/05/more-about-nginx-dns-resolution-than-you-ever-wanted-to-know/"/>
    <updated>2019-05-17T12:58:38-04:00</updated>
    <id>https://www.davidxia.com/2019/05/more-about-nginx-dns-resolution-than-you-ever-wanted-to-know</id>
    <content type="html"><![CDATA[<p>This is a post about Nginx&rsquo;s DNS resolution behavior I didn&rsquo;t know about but wish I did before I
started using Kubernetes (K8s).</p>

<h2>Nginx caches statically configured domains once</h2>

<h3>Symptoms</h3>

<p>I moved a backend service <code>foo</code> from running on a virtual
machine to K8s. Foo&rsquo;s clients include an Nginx instance configured with this <code>upstream</code>
block.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>upstream foo {
</span><span class='line'>  server foo.example.com.;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>server {
</span><span class='line'>  ...
</span><span class='line'>
</span><span class='line'>  location ~* /_foo/(.*) {
</span><span class='line'>    proxy_pass https://foo/$1;
</span><span class='line'>    ...
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>K8s Pods can be rescheduled anytime so their IPs aren&rsquo;t stable. I&rsquo;m supposed to use K8s Services
to avoid caching these ephemeral Pod IPs. But in my case because of interoperability reasons I was
registering Pod IPs directly as A records for <code>foo.example.com.</code>. I started noticing that after my Pod
IPs changed either because of rescheduling or updating the Deployment, Nginx started throwing
<code>502 Bad Gateway</code> errors.</p>

<h3>Root Problem</h3>

<p>Nginx resolves statically configured domain names only once at startup or configuration
reload time. So Nginx resolved <code>foo.example.com.</code> once at startup to several Pod IPs and cached
them forever.</p>

<h3>Solution</h3>

<!-- more -->


<p>Using a variable for the domain name will make Nginx resolve and cache it using the TTL value of the
DNS response. So replace the <code>upstream</code> block with a variable. I have no idea why it has to be a
variable to make Nginx resolve the domain periodically.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>set $foo_url foo.example.com.;</span></code></pre></td></tr></table></div></figure>


<p>And replace the <code>proxy_pass</code> line with</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  location ~* /_foo/(.*) {
</span><span class='line'>    proxy_pass https://$foo_url/$1;
</span><span class='line'>    ...
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>This behavior isn&rsquo;t documented but has been observed empirically and discussed <a href="https://serverfault.com/a/593003/88755">here</a>, <a href="https://stackoverflow.com/a/41476524/553994">here</a>,
and <a href="https://www.ruby-forum.com/t/using-127-0-0-1-in-resolver/238180/4">here</a>. I also learned that this setup requires me to define a <code>resolver</code> in the Nginx configs.
<strong>For some reason Nginx resolves statically configured domains by querying the nameserver specified in
<code>/etc/resolv.conf</code> but periodically resolved domains require a completely different config
setting.</strong> I would love to know why.</p>

<p>The VM on which Nginx was running ran a Bind DNS server locally, so I set <code>resolver 127.0.0.1</code>.
I triggered the code path that made Nginx send requests to foo and saw periodic DNS queries
occurring with <code>sudo tcpdump -i lo -n dst port 53 | grep foo</code>.</p>

<h2>What if that Nginx is also running on K8s?</h2>

<h3>Problem</h3>

<p>I had another Nginx instance that also made requests to foo. This Nginx was running on K8s too. It
was created with this Deployment YAML.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apps/v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deployment</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">matchLabels</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'>    <span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'>        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">openresty/openresty:trusty</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https</span>
</span><span class='line'>            <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">443</span>
</span><span class='line'>            <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">TCP</span>
</span><span class='line'>        <span class="l-Scalar-Plain">volumeMounts</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-config</span>
</span><span class='line'>            <span class="l-Scalar-Plain">mountPath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/nginx/conf.d</span>
</span><span class='line'>      <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-config</span>
</span><span class='line'>          <span class="l-Scalar-Plain">configMap</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-config</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>nginx-config</code> ConfigMap was</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ConfigMap</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-config</span>
</span><span class='line'><span class="l-Scalar-Plain">data</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">nginx.conf</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>    <span class="no">upstream foo {</span>
</span><span class='line'>      <span class="no">server foo.example.com.:443;</span>
</span><span class='line'>    <span class="no">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">server {</span>
</span><span class='line'>      <span class="no">...</span>
</span><span class='line'>
</span><span class='line'>      <span class="no"># use regex capture to preserve url path and query params</span>
</span><span class='line'>      <span class="no">location ~* /_foo/(.*) {</span>
</span><span class='line'>        <span class="no">proxy_pass https://foo/$1;</span>
</span><span class='line'>        <span class="no">...</span>
</span><span class='line'>      <span class="no">}</span>
</span><span class='line'>    <span class="no">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I replaced <code>upstream</code> with the same pattern above, but in this case when I needed to define
<code>resolver</code> I couldn&rsquo;t use <code>127.0.0.1</code> because there&rsquo;s no Bind running locally. I can&rsquo;t hardcode the
resolver because it might change.</p>

<h3>Solution: run Nginx and foo on the same K8s cluster and use the cluster-local Service DNS record</h3>

<p>If Nginx and foo run on the same K8s cluster, I can use the cluster-local DNS record created by a
K8s Service matching the foo Pods. A Service like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Service</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bar</span>
</span><span class='line'><span class="nn">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>will create a DNS A record <code>foo.bar.svc.cluster.local.</code> pointing to the K8s Service&rsquo;s IP.
Since this Service&rsquo;s IP is stable and it load balances requests to the underlying Pods, there&rsquo;s no need for Nginx to
periodically lookup the Pod IPs. I can keep the <code>upstream</code> block like so.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">upstream foo {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">server foo.bar.svc.cluster.local.:443;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As its name implies, <code>foo.bar.svc.cluster.local.</code> is only resolvable within the cluster. So
Nginx has to be running on the same cluster as foo.</p>

<h3>Solution: dynamically set the Nginx <code>resolver</code> equal to the system&rsquo;s when the Pod starts</h3>

<p>What if Nginx is on another K8s cluster? Then I can set <code>resolver</code> to the IP of one of the
nameservers in <code>/etc/resolv.conf</code>. After a bunch of tinkering I came up with this way to dynamically
set the Nginx <code>resolver</code> when the Pod starts. A placeholder for <code>resolver</code> is set in the Nginx
ConfigMap, and a command at Pod startup copies over the templated config and replaces the
placeholder with a nameserver IP from <code>/etc/resolv.conf</code>.</p>

<p>Change <code>nginx-config</code> ConfigMap to</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ConfigMap</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-config</span>
</span><span class='line'><span class="l-Scalar-Plain">data</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">nginx.conf.template</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>    <span class="no">server {</span>
</span><span class='line'>      <span class="no">...</span>
</span><span class='line'>
</span><span class='line'>      <span class="no"># This directive is dynamic because we set it to the</span>
</span><span class='line'>      <span class="no"># kube-dns Service IP which is different for each cluster.</span>
</span><span class='line'>      <span class="no">resolver $NAMESERVER;</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">set $foo_url foo.example.com.;</span>
</span><span class='line'>
</span><span class='line'>      <span class="no"># use regex capture to preserve url path and query params</span>
</span><span class='line'>      <span class="no">location ~* /_foo/(.*) {</span>
</span><span class='line'>        <span class="no">proxy_pass https://$foo_url/$1;</span>
</span><span class='line'>        <span class="no">...</span>
</span><span class='line'>      <span class="no">}</span>
</span><span class='line'>    <span class="no">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deployment YAML then becomes (note the added <code>command</code>, <code>args</code>, and new <code>volume</code> and <code>volumeMount</code>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apps/v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deployment</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">matchLabels</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'>    <span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'>        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">openresty/openresty:trusty</span>
</span><span class='line'>        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&#39;/bin/bash&#39;</span><span class="p-Indicator">,</span> <span class="s">&#39;-c&#39;</span><span class="p-Indicator">]</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">|</span>
</span><span class='line'>          <span class="no">export NAMESERVER=$(grep &#39;nameserver&#39; /etc/resolv.conf | awk &#39;{print $2}&#39; | tr &#39;\n&#39; &#39; &#39;)</span>
</span><span class='line'>          <span class="no">echo &quot;Nameserver is: $NAMESERVER&quot;</span>
</span><span class='line'>          <span class="no">echo &#39;Copying nginx config&#39;</span>
</span><span class='line'>          <span class="no">envsubst &#39;$NAMESERVER&#39; &lt; /etc/nginx/conf.d.template/nginx.conf.template &gt; /etc/nginx/conf.d/nginx.conf</span>
</span><span class='line'>          <span class="no">echo &#39;Using nginx config:&#39;</span>
</span><span class='line'>          <span class="no">cat /etc/nginx/conf.d/nginx.conf</span>
</span><span class='line'>          <span class="no">echo &#39;Starting nginx&#39;</span>
</span><span class='line'>          <span class="no">nginx -g &#39;daemon off;&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https</span>
</span><span class='line'>            <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">443</span>
</span><span class='line'>            <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">TCP</span>
</span><span class='line'>        <span class="l-Scalar-Plain">volumeMounts</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-config-template</span>
</span><span class='line'>            <span class="l-Scalar-Plain">mountPath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/nginx/conf.d.template</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-config</span>
</span><span class='line'>            <span class="l-Scalar-Plain">mountPath</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/nginx/conf.d</span>
</span><span class='line'>      <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-config</span>
</span><span class='line'>          <span class="l-Scalar-Plain">emptyDir</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-config-template</span>
</span><span class='line'>          <span class="l-Scalar-Plain">configMap</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-config</span>
</span></code></pre></td></tr></table></div></figure>


<p>A <code>volume</code> of type <code>emptyDir</code> is needed because recent versions of K8s made configMap volumes
read-only. EmptyDir types are writable.</p>

<p>Hopefully this helps some people out there who don&rsquo;t want to spend as much time as I did Googling
obscure Nginx behavior.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Upstream Kubernetes Java Models Is Much Better Than Raw YAML]]></title>
    <link href="https://www.davidxia.com/2018/11/using-upstream-kubernetes-java-models-is-much-better-than-raw-yaml/"/>
    <updated>2018-11-11T17:11:38-05:00</updated>
    <id>https://www.davidxia.com/2018/11/using-upstream-kubernetes-java-models-is-much-better-than-raw-yaml</id>
    <content type="html"><![CDATA[<p>It&rsquo;s been a while since I blogged about something tech related, but I had some
free time today.</p>

<p>Recently, I&rsquo;ve been trying to refactor an internal Spotify deployment tool my
team built and maintains. This deployment tool takes Kubernetes (k8s) YAML
manifests, changes them, and essentially runs <code>kubectl apply</code>. We add metadata
to the k8s manifests like labels.</p>

<p>Right now this tool receives the input YAML as strings, converts them to
Jackson ObjectNodes, and manipulates those ObjectNodes. The disadvantage of
this is that there&rsquo;s no k8s type-safety. We might accidentally add a field to a
Deployment that isn&rsquo;t valid or remove something from a Service that&rsquo;s required.</p>

<p>My refactor uses upstream k8s model classes from <a href="https://github.com/kubernetes-client/java">kubernetes-client/java</a>
which are themselves <a href="https://github.com/kubernetes-client/gen">generated</a> from the official Swagger spec. Here&rsquo;s a
helpful Yaml utility class that deserializes YAML strings into concrete classes
and can also serialize them back into YAML strings. So helpful.</p>

<p>Unfortunately, there&rsquo;s some bugs in the YAML (de)serialization that prevent me
from finishing this effort.</p>

<ul>
<li><a href="https://github.com/kubernetes-client/java/pull/417">kubernetes-client/java issue 417</a></li>
<li><a href="https://github.com/kubernetes-client/java/issues/431">kubernetes-client/java issue 431</a></li>
<li><a href="https://github.com/kubernetes-client/java/issues/340">kubernetes-client/java issue 340</a></li>
</ul>


<p>Nonetheless, it&rsquo;ll be much nicer to change k8s resources in a type-safe way
instead of parsing and rewriting raw YAML strings.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Internet Meme Role Models]]></title>
    <link href="https://www.davidxia.com/2018/01/internet-meme-role-models/"/>
    <updated>2018-01-07T11:29:18-05:00</updated>
    <id>https://www.davidxia.com/2018/01/internet-meme-role-models</id>
    <content type="html"><![CDATA[<p>I&rsquo;m compiling a list of Internet meme role models. Here&rsquo;s what I have so far. These people &mdash;
they must be real human beings &mdash; must have either gone out of their way to do the right
thing in a smart manner, something courageous with bonus points for being funny, or just be
ridiculous. And they must be memeified. Exceptions will be made for exceptional but not
memeified people like Hilde Lysiak.</p>

<p>Who else deserves to be on this list?</p>

<ul>
<li><a href="https://www.youtube.com/watch?v=b58mzz7mQpg">Snack Man</a> defused a violent fight on the subway between a couple before anyone got hurt. He did
it by standing in between them and munching on Pringles and Gummy Bears.</li>
<li><a href="https://www.youtube.com/watch?v=m9Md78SJO6s">Ben Innes</a> asked the EgyptAir Flight 181 hijacker who comandeered the airplane with a fake
explosive belt if he could take a selfie with him. &ldquo;I thought, why not? If he blows us all up it
won&rsquo;t matter anyway.&rdquo;</li>
<li><a href="https://www.nytimes.com/2017/10/31/books/hilde-lysiak-child-reporter.html">Hilde Lysiak</a> is ten years old and the writer and publisher of Orange Street News.
She <a href="https://www.youtube.com/watch?v=0ShfNQOUeAY">doesn&rsquo;t take shit from anyone</a>.</li>
<li>Salt Bae is&hellip;well you just have to <a href="https://www.youtube.com/watch?v=xWMWJwXvzWk&amp;t=376s">see for yourself</a>.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Now Max Knows How to Make a Latte]]></title>
    <link href="https://www.davidxia.com/2017/08/now-max-knows-how-to-make-a-latte/"/>
    <updated>2017-08-30T01:19:06-04:00</updated>
    <id>https://www.davidxia.com/2017/08/now-max-knows-how-to-make-a-latte</id>
    <content type="html"><![CDATA[<p>I work at a music company but am more interested in politics and history. Artists visit our
office often.</p>

<p>So I, often being ignorant of their fame, have casually interacted with them or criticized their
milk steaming techniques when they&rsquo;re using the office&rsquo;s $20K espresso machine.</p>

<p>Only later am I told by their posse, &ldquo;Did you know that was Mark Ronson/Bebe Rhexa/Max Martin/etc?&rdquo;</p>

<p>&ldquo;It&rsquo;s OK,&rdquo; I say. &ldquo;Now Max knows how to make a real latte.&rdquo;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Making Dumplings With My Grandparents]]></title>
    <link href="https://www.davidxia.com/2017/07/making-dumplings-with-my-grandparents/"/>
    <updated>2017-07-05T22:50:03-04:00</updated>
    <id>https://www.davidxia.com/2017/07/making-dumplings-with-my-grandparents</id>
    <content type="html"><![CDATA[<p>Whenever I go back home to my parents&#8217; house near Boston,
if my maternal grandparents are there, they make hundreds of dumplings for me.
I try to help out. We make everything from scratch including the skins. I&rsquo;m good at rolling the
skins but have much to learn on all other parts of the process. I&rsquo;m becoming better at packing
and closing the dumplings now though.</p>

<p>I&rsquo;ve come to cherish this little tradition more and more. I need to plan my next trip to Boston!</p>

<p><img class="center" src="https://i.imgur.com/FkpZb8Jh.jpg"></p>

<!-- more -->


<p><img class="center" src="https://i.imgur.com/InwCZuBh.jpg"></p>

<p><img class="center" src="https://i.imgur.com/bT9F8neh.jpg"></p>

<p><img class="center" src="https://i.imgur.com/qMkalGoh.jpg"></p>

<iframe class="fill-width" width="560" height="315" src="https://www.youtube.com/embed/shNvpsrlaF0" frameborder="0" allowfullscreen></iframe>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Four Fascinating and Weird People]]></title>
    <link href="https://www.davidxia.com/2017/06/four-fascinating-and-weird-people/"/>
    <updated>2017-06-01T06:36:06-04:00</updated>
    <id>https://www.davidxia.com/2017/06/four-fascinating-and-weird-people</id>
    <content type="html"><![CDATA[<p>Here are the stories of four fascinating and weird people that will make you laugh, be inspired,
or cringe. Chang and Eng Bunker were conjoined twins who married two sisters and were slave-owners
on the side of the Southern Confederacy. Rose Wilder Lane is the daughter of the author who wrote
the <em>Little House</em> childrens books, a founding member of the American Libertarian movement, and just
all around boss ass bitch. John Harvey Kellogg was the inventor of corn flakes, doctor, zealous
anti-masturbation campaigner, and eugenicist.</p>

<!-- more -->


<h2>1. Chang and Eng Bunker</h2>

<p><a href="https://en.wikipedia.org/wiki/Chang_and_Eng_Bunker">Chang and Eng</a> were two conjoined twins born
in Vietnam in the 1800s. The term &ldquo;Siamese twins&rdquo; is based on them.</p>

<blockquote><p>The brothers were joined at the sternum by a small piece of cartilage, and though their livers
  were fused, they were independently complete.</p></blockquote>

<p>After a Scotsman noticed them and paraded them around as a freak show attraction for ten
years, the Bunker twins settled down in Wilkesboro, North Carolina. They married two local white
women who were sisters. They became naturalized American citizens and even owned slaves.</p>

<p>The Bunkers and their wives slept in a bed built for four. After a while their wives started to not
get along. So they alternated between two different houses. Chang had twelve children while
Eng had ten. Today their descendents number more than 1,500 and hold reunions. Their liver is on
display in at the Mütter Museum in Philadelphia, Pennsylvania.</p>

<h2>2. Rose Wilder Lane</h2>

<p><a href="https://en.wikipedia.org/wiki/Rose_Wilder_Lane">Rose Wilder Lane</a> was the eldest child of Laura
Ingalls Wilder, the ostensible author of the <a href="https://en.wikipedia.org/wiki/List_of_Little_House_on_the_Prairie_books">Little House book series</a>.
Lane was by all means a boss ass bitch who lived a full life.</p>

<p>Sick of crop failures and tough frontier life, Lane moved in 1908 to San Francisco, California.
She married a salesman named Gillette Lane and became pregnant. Sadly, her son was stillborn, and
a subsequent surgery left her unable to have kids.</p>

<blockquote><p>She felt her intellectual interests did not mesh with the life she was living with her husband.
Keenly aware of her lack of a formal education, during these years, Lane read voraciously and
taught herself several languages. Her writing career began around 1908, with occasional
freelance newspaper jobs that earned much-needed extra cash.</p><footer><strong>Early career, marriage and divorce</strong> <cite><a href='https://en.wikipedia.org/wiki/Rose_Wilder_Lane#Early_career.2C_marriage_and_divorce'>en.wikipedia.org/wiki/&hellip;</a></cite></footer></blockquote>


<p>Lane&rsquo;s writing career took off. She wrote for publications like <em>Harper&rsquo;s</em> and <em>Saturday Evening
Post</em>.</p>

<blockquote><p>In the late 1920s, Lane was reputed to be one of the highest-paid female writers in America, and
along with Hoover, she counted among her friends well known figures such as Sinclair Lewis,
Isabel Paterson, Dorothy Thompson, John Patric, and Lowell Thomas.</p><footer><strong>Freelance writing career</strong> <cite><a href='https://en.wikipedia.org/wiki/Rose_Wilder_Lane#Freelance_writing_career'>en.wikipedia.org/wiki/&hellip;</a></cite></footer></blockquote>


<p>When Lane&rsquo;s mother approached her with a rough autobiographical manuscript of her own childhood,
Lane sensed that an American public fatigued by the Great Depression would take to the story of
the loving, persistent, and independent Ingalls family. Lane encouraged and helped her mother
rewrite and sell the story as a children&rsquo;s novel. The book became a big success, and an entire
series replete with T.V. shows, merchandise, and museums followed. Their family was raking
in the dough.</p>

<p>I read the entire series as a kid and stil wax nostalgic for it. I thought Lane&rsquo;s mother, who&rsquo;s the
titled author, wrote every book on her own and only received encouragement from her Lane. It turns
out, however, that the truth is more interesting.</p>

<blockquote><p>&#8230;an ongoing mutual collaboration that involved Lane more extensively in the
earlier books, and to a much lesser extent by the time the series ended, as Wilder&#8217;s confidence
in her own writing ability increased. Lane insisted to the end that her role was little more than
that of her mother&#8217;s adviser, despite documentation to the contrary&#8230;Literary historians
believe that Lane&#8217;s editing skills brought the dramatic pacing, literary structure, and
characterization critically needed to make the stories publishable in book form.</p><footer><strong>Literary collaboration</strong> <cite><a href='https://en.wikipedia.org/wiki/Rose_Wilder_Lane#Literary_collaboration'>en.wikipedia.org/wiki/&hellip;</a></cite></footer></blockquote>


<p>Even more fascinating is Lane&rsquo;s societal and political views. She was a libertarian, economically
laissez faire, anti-racist, and anti-communist. She protested paying income taxes, opposed the New
Deal, and thought Social Security was a Ponzi scheme that would destroy the United States.</p>

<blockquote><p>Lane played a hands-on role during the 1940s and 1950s in launching the &#8220;libertarian movement&#8221;
and began an extensive correspondence with figures such as DuPont executive Jasper Crane and
writer Frank Meyer, as well as her friend and colleague, Ayn Rand. She wrote book reviews
for the National Economic Council and later for the Volker Fund, out of which grew the Institute
for Humane Studies. Later, she lectured at, and gave generous financial support to, the Freedom
School headed by libertarian Robert LeFevre.</p><footer><strong>Later years and death</strong> <cite><a href='https://en.wikipedia.org/wiki/Rose_Wilder_Lane#Later_years_and_death'>en.wikipedia.org/wiki/&hellip;</a></cite></footer></blockquote>


<p>I want to reread the <em>Little House</em> books now knowing she was a die-hard libertarian who along with
her mother purposefully wove themes of individualism into the series.</p>

<blockquote><p>Rose Wilder Lane died in her sleep at age 81, on October 30, 1968, just as she was about to
depart on a three-year world tour. She was buried next to her parents at Mansfield Cemetery in
Mansfield, Missouri.</p><footer><strong>Later years and death</strong> <cite><a href='https://en.wikipedia.org/wiki/Rose_Wilder_Lane#Later_years_and_death'>en.wikipedia.org/wiki/&hellip;</a></cite></footer></blockquote>


<h2>3. John Harvey Kellogg</h2>

<p>I haven&rsquo;t read the entire Wikipedia entry on <a href="https://en.wikipedia.org/wiki/John_Harvey_Kellogg">John Harvey Kellogg</a> yet since
a colleague only recently drew my attention to this smart, prolific, and bizarre man. These parts
stood out to me at first glance though.</p>

<ul>
<li>he invented corn flakes with his brother, Will Keith Kellogg</li>
<li>he was a medical doctor &ldquo;who ran a sanitarium using holistic methods, with a particular focus on
nutrition, enemas, and exercise. Kellogg was an advocate of vegetarianism&rdquo;</li>
<li>he also created various phototherapeutic and electrotherapeutic inventions</li>
<li>he advocated sexual abstinence and &ldquo;advocated keeping the diet plain to prevent sexual arousal&rdquo;</li>
<li>he was an &ldquo;especially zealous campaigner against masturbation&rdquo;</li>
</ul>


<blockquote><p>He also recommended, to prevent children from this &#8220;solitary vice&#8221;, bandaging or tying their hands,
covering their genitals with patented cages and electrical shock.</p><footer><strong>Masturbation prevention</strong> <cite><a href='https://en.wikipedia.org/wiki/John_Harvey_Kellogg#Masturbation_prevention'>en.wikipedia.org/wiki/&hellip;</a></cite></footer></blockquote>


<ul>
<li>he liked yogurt enemas</li>
<li>he was a eugenicist</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Useful Site for TLS Server Test]]></title>
    <link href="https://www.davidxia.com/2017/05/useful-site-for-testing-tls-server-configuration/"/>
    <updated>2017-05-20T12:49:20-04:00</updated>
    <id>https://www.davidxia.com/2017/05/useful-site-for-testing-tls-server-configuration</id>
    <content type="html"><![CDATA[<p>My home server&rsquo;s hard disk&rsquo;s partition map was somehow corrupted. So I&rsquo;m serving this website
from <a href="https://m.do.co/c/74c553045962">Digital Ocean</a> for now instead of my apartment. While rewriting the nginx server configs,
I found this useful site that <a href="https://www.ssllabs.com/ssltest/index.html">tests your server&rsquo;s TLS configuration</a>. It&rsquo;ll give you a grade
and warn you of weak encryption, key exchange protocols, cipher suites, etc.</p>

<p><a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">Mozilla&rsquo;s TLS configuration generator</a> is useful for providing secure defaults.</p>

<p>I&rsquo;m proud to say this site has an A.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[British Virgin Islands Sailing Trip Video]]></title>
    <link href="https://www.davidxia.com/2017/05/british-virgin-islands-sailing-trip-video/"/>
    <updated>2017-05-20T11:51:50-04:00</updated>
    <id>https://www.davidxia.com/2017/05/british-virgin-islands-sailing-trip-video</id>
    <content type="html"><![CDATA[<p>I finally got around to editing the footage from the sailing trip.</p>

<iframe class="fill-width" width="560" height="315" src="https://www.youtube.com/embed/7ZaCY7rHLgg" frameborder="0" allowfullscreen></iframe>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[British Virgin Islands Sailing Trip]]></title>
    <link href="https://www.davidxia.com/2017/03/british-virgin-islands-sailing-trip/"/>
    <updated>2017-03-03T21:10:36-05:00</updated>
    <id>https://www.davidxia.com/2017/03/british-virgin-islands-sailing-trip</id>
    <content type="html"><![CDATA[<p>I learned the basics of sailing on a week-long sailing trip in the British Virgin Islands aboard
a 48-foot catamaran we called Millenium Falcon.</p>

<h3>January 30</h3>

<p>We moored off the coast of Virgin Gorda and Saba Rock. President Obama was wind surfing at neighboring Necker Island as a guest of Richard Branson.</p>

<p><img class="center" src="https://i.imgur.com/xtJYYezh.jpg"></p>

<div class='image center'><img  src="https://i.imgur.com/WY4BnbMh.jpg" title="The dinghy race at Virgin Gorda." ><div class='caption'>The dinghy race at Virgin Gorda.</div></div>




<!-- more -->


<h3>January 31</h3>

<p>Anegada</p>

<p><img class="center" src="https://i.imgur.com/eZ8wlJjh.jpg"></p>

<p><img class="center" src="https://i.imgur.com/8BhieRQh.jpg"></p>

<p><img class="center" src="https://i.imgur.com/Z9eqNS4h.jpg"></p>

<p><img class="center" src="https://i.imgur.com/vGEIw30h.jpg"></p>

<h3>Last day - February 4</h3>

<p>Sailing through Tatch Island Cut during the race. We stopped racing because the wind died
and we needed to return the charter boat on time.</p>

<p><img class="center" src="https://i.imgur.com/rOfYB1Uh.jpg"></p>

<p><img class="center" src="https://i.imgur.com/qofwLFhh.jpg"></p>

<p><img class="center" src="https://i.imgur.com/3VJRFjHh.jpg"></p>

<p><img class="center" src="https://i.imgur.com/rfuiRe4h.jpg"></p>

<div class='image center'><img  src="https://i.imgur.com/IOXPlZxh.jpg" title="Boat mate and colleague Bastian." ><div class='caption'>Boat mate and colleague Bastian.</div></div>




<div class='image center'><img  src="https://i.imgur.com/VcsIgQAh.jpg" title="The rest of my boat's crew." ><div class='caption'>The rest of my boat&#8217;s crew.</div></div>




<div class='image center'><img  src="https://i.imgur.com/62Prw81h.jpg" title="We saw lots of nice houses built on cliffs." ><div class='caption'>We saw lots of nice houses built on cliffs.</div></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Test Your Home's Water for Lead]]></title>
    <link href="https://www.davidxia.com/2017/02/how-to-test-your-homes-water-for-lead/"/>
    <updated>2017-02-20T19:37:52-05:00</updated>
    <id>https://www.davidxia.com/2017/02/how-to-test-your-homes-water-for-lead</id>
    <content type="html"><![CDATA[<p>I read the <em>New York Times</em> article <a href="https://www.nytimes.com/interactive/2016/03/24/nyregion/how-nyc-gets-its-water-new-york-101.html">&ldquo;How New York Gets Its Water&rdquo;</a> a while ago. The end of the
article described how you could order a free lead testing kit.</p>

<blockquote><p>The <a href="https://www.epa.gov/sites/production/files/2015-11/documents/2005_09_14_faq_fs_homewatertesting.pdf">EPA offers some guidance</a> on how and when to obtain an in-home testing kit through your local
water supplier. In New York City, residents can obtain one <a href="http://www1.nyc.gov/nyc-resources/service/1266/water-lead-test-kit-request">at no cost through 311</a>.</p>

<p>For more information, visit <a href="www.epa.gov/safewater/lead">www.epa.gov/safewater/lead</a>, or call the Safe Drinking Water Hotline
at 1-800-426-4791.</p></blockquote>

<p>I read this article in the aftermath of the <a href="https://en.wikipedia.org/wiki/Flint_water_crisis">Flint water crisis</a> and wanted to test my
apartment&rsquo;s drinking water. I filled out the online form, received a package in the mail containing
two large plastic bottles, a pre-paid mailing label, and detailed instructions. The instructions
said to fill one bottle with water after not using any faucet in my apartment for six hours. I
filled the second bottle with water after having run the tap. After dropping the bottles now full
of water into a mailbox, NYC&rsquo;s Nureau of Water Supply sent me the results only week or so later.</p>

<blockquote><p>We have received the results of your recent tap water lead test. Both samples were under the
federal action level of 15 micrograms per liter (μg/L). Your specific results were:</p>

<p>First draw: 0 μg/L
1-2 minute flush: 0 μg/L</p></blockquote>

<p><img class="center" src="https://i.imgur.com/uxwBi0bl.jpg"></p>

<p><img class="center" src="https://i.imgur.com/98MoXGNl.jpg"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[What I'm Looking for in a Volunteering Position]]></title>
    <link href="https://www.davidxia.com/2016/10/what-im-looking-for-in-a-volunteering-position/"/>
    <updated>2016-10-31T13:59:34-04:00</updated>
    <id>https://www.davidxia.com/2016/10/what-im-looking-for-in-a-volunteering-position</id>
    <content type="html"><![CDATA[<h2>My Absolute Requirements</h2>

<ul>
<li><strong>Does not require a law degree</strong>

<ul>
<li>Although I have thought about getting one just so I can apply for certain volunteering gigs that require one.</li>
</ul>
</li>
<li><strong>Does not require me to write code</strong> for a significant portion of my volunteer time. I already do
that full time and am not looking for more. I am fine giving high level tech guidance, however.</li>
</ul>


<h2>My Preferences</h2>

<p><em>In rough order of preference</em></p>

<ul>
<li>in-person and local</li>
<li>intellectually challenging</li>
<li>accommodating of my full time work schedule and personal life</li>
<li>5-10 hours a week</li>
<li>months-long to year-long commitment</li>
<li>not just a desk job but also field work</li>
</ul>


<h2>Skills I Want to Learn or Improve Upon</h2>

<p><em>In rough order of preference</em></p>

<ul>
<li>public speaking</li>
<li>community organizing and building trust with people who have different backgrounds</li>
<li>negotiating and building consensus with and between people who don&rsquo;t necessarily see eye-to-eye</li>
<li>Learning to lobby public officials and organizations</li>
<li>learning more about the law or government or various industries</li>
<li>investigative reporting</li>
</ul>


<h2>Values of Organizations in which I&rsquo;ll Thrive</h2>

<p><em>In rough order of preference</em></p>

<ul>
<li>competence</li>
<li>hard work</li>
<li>innovation or at least open-mindedness</li>
<li>passion and compassion</li>
<li>personal responsibility</li>
</ul>


<h2>Skills I Can Contribute</h2>

<p><em>In rough order of ability</em></p>

<ul>
<li>writing code, creating web sites, general computer stuff (see my <a href="https://github.com/davidxia">github</a>)</li>
<li>writing prose such as reports, summaries, and essays (see my <a href="https://www.davidxia.com/">blog</a>)</li>
<li>analytical and quantitative (I was a math major in college. Now I work at Spotify as a software
engineer.)</li>
<li>effective at collaborating and working as part of a team</li>
<li>good at spoken communication</li>
<li>has a knack for establishing rapport and building strong relationships with all kinds of people</li>
</ul>


<!-- more -->


<h2>Causes I Believe In</h2>

<p><em>In rough order of preference</em></p>

<ul>
<li>civil rights

<ul>
<li>&ldquo;protect individuals&#8217; freedom from infringement by governments, social organizations, and
private individuals. They ensure one&rsquo;s ability to participate in the civil and political life
of the society and state without discrimination or repression&rdquo;</li>
</ul>
</li>
<li><a href="https://en.wikipedia.org/wiki/Environmentalism">environmentalism</a>

<ul>
<li>&ldquo;advocate for the lawful preservation, restoration and/or improvement of the natural
environment&rdquo;</li>
<li>&ldquo;attempt to balance relations between humans and the various natural systems on which they
depend in such a way that all the components are accorded a proper degree of sustainability&rdquo;</li>
</ul>
</li>
<li><a href="https://en.wikipedia.org/wiki/Consumer_protection">consumer protection</a>

<ul>
<li>&ldquo;promoting laws and organizations that ensure the rights of consumers as well as fair trade,
competition and accurate information in the marketplace. The laws are designed to prevent
businesses that engage in fraud or specified unfair practices from gaining an advantage over
competitors&rdquo;</li>
</ul>
</li>
<li><a href="http://www.nypirg.org/goodgov/">good governance</a>

<ul>
<li>&ldquo;advocate for eliminating barriers to voting, fighting for better ethics oversight and limiting
the role of powerful interests in elections,&rdquo; etc</li>
<li>examples include making &ldquo;campaign finance information for state and local candidates&rdquo;
available on the Internet, reporting &ldquo;lobbying of state agencies and local governments&rdquo;,
deterring and justly punishing ethical misconduct, and making legislative and budgetary
processes more transparent.</li>
</ul>
</li>
<li><a href="https://en.wikipedia.org/wiki/Labor_rights">labor rights</a>

<ul>
<li>advocating for &ldquo;legal rights and claimed human rights having to do with labor relations
between workers and their employers, usually obtained under labor and employment law. In
general, these rights&#8217; debates have to do with negotiating workers&#8217; pay, benefits, and safe
working conditions&rdquo;</li>
<li>e.g. <a href="http://www.nytimes.com/2016/08/24/business/graduate-students-clear-hurdle-in-effort-to-form-union.html">Grad Students Win Right to Unionize in an Ivy League Case</a></li>
</ul>
</li>
<li><a href="https://en.wikipedia.org/wiki/Community_organizing">community organizing</a>

<ul>
<li>&ldquo;community organizers generally assume that social change necessarily involves conflict and
social struggle in order to generate collective power for the powerless. A core goal of
community organizing is to generate durable power for an organization representing the
community, allowing it to influence key decision-makers on a range of issues over time&rdquo;</li>
</ul>
</li>
<li><a href="https://en.wikipedia.org/wiki/Community_development#Definitions">community development</a></li>
<li>Education</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Recent Family Photo]]></title>
    <link href="https://www.davidxia.com/2016/09/a-recent-family-photo/"/>
    <updated>2016-09-18T18:29:07-04:00</updated>
    <id>https://www.davidxia.com/2016/09/a-recent-family-photo</id>
    <content type="html"><![CDATA[<div class='image center'><img  src="https://i.imgur.com/mwtquEjl.jpg" width="640" height="640" title="Post-dimsum photo with my parents and maternal grandparents on their weekend visit to NYC." ><div class='caption'>Post-dimsum photo with my parents and maternal grandparents on their weekend visit to NYC.</div></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Southern UK 2016]]></title>
    <link href="https://www.davidxia.com/2016/07/southern-uk-2016/"/>
    <updated>2016-07-24T18:09:24-04:00</updated>
    <id>https://www.davidxia.com/2016/07/southern-uk-2016</id>
    <content type="html"><![CDATA[<p>My trip with my parents to southern UK in March this year. The video includes highlights from
London, Cambridge, Seven Sisters, Jurassic Coast, Lyme Regis, and Lulworth Cove.</p>

<iframe class="fill-width" width="540" height="304" src="https://www.youtube-nocookie.com/embed/seJO_6-Tk2Q?rel=0" frameborder="0" allowfullscreen></iframe>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[My First Sailing Class]]></title>
    <link href="https://www.davidxia.com/2016/07/my-first-sailing-class/"/>
    <updated>2016-07-24T13:37:56-04:00</updated>
    <id>https://www.davidxia.com/2016/07/my-first-sailing-class</id>
    <content type="html"><![CDATA[<p>Last weekend a bunch of Spotify collleagues and I took our first sailing classes at Manhattan Yacht
Club in Jersey City. I could get used to this sport. The sun was brutal though. I&rsquo;ll never get used
to that.</p>

<iframe class="fill-width" width="540" height="405" src="https://www.youtube.com/embed/8hPEr4sa-YM" frameborder="0" allowfullscreen></iframe>




<!-- more -->


<p><img class="center" src="https://i.imgur.com/g6jwSpXl.jpg" width="480" height="640"></p>

<div class='image center'><img  src="https://i.imgur.com/rbyvOtml.jpg" width="480" height="640" title="I had to wear a hot and stuffy life vest on a 90-degree day." ><div class='caption'>I had to wear a hot and stuffy life vest on a 90-degree day.</div></div>




<div class='image center'><img  src="https://i.imgur.com/5cHxUtKl.jpg" width="480" height="640" title="A great view of lower Manhattan." ><div class='caption'>A great view of lower Manhattan.</div></div>




<div class='image center'><img  src="https://i.imgur.com/ivnVCYXl.jpg" width="480" height="640" title="Sailing close to the Statue of Liberty." ><div class='caption'>Sailing close to the Statue of Liberty.</div></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Spotify-organized Surfing Trip in Santa Teresa, Costa Rica 2015]]></title>
    <link href="https://www.davidxia.com/2016/07/spotify-organized-surfing-trip-in-costa-rica-2015/"/>
    <updated>2016-07-09T10:13:29-04:00</updated>
    <id>https://www.davidxia.com/2016/07/spotify-organized-surfing-trip-in-costa-rica-2015</id>
    <content type="html"><![CDATA[<p>In March 2015, about twenty colleagues and I went on a Spotify-organized surf trip to Santa Teresa,
Costa Rica for a week of surf lessons. The company, surf, and food were unforgettable. One of Spotify&rsquo;s
social events organizers knew <a href="www.surfakademin.se">a group of traveling Swedish surf instructors</a>,
and helped get a group discount for Spotifiers and their guests. The total cost of lodging, lessons,
and daily breakfast and lunch was about $650 for a week.</p>

<div class='image center'><img  src="https://i.imgur.com/WvJyqW4l.jpg" width="640" height="480" title="The relaxing mini-resort where we stayed. It had a pool, lounge areas, and a small cafe." ><div class='caption'>The relaxing mini-resort where we stayed. It had a pool, lounge areas, and a small cafe.</div></div>


<p>The best memories I have from the trip are waking up at the crack of dawn every day, grabbing a
surf board, and rushing headlong into the water. The sun was gentle in the early morning, but the
waves were not. The force and speed of the ocean awed and at times terrified me. I&rsquo;d paddle like mad
to get over waves, but every once in a while, a monster swell would catch me at the worst moment.
The crest of the wave would hit me like a hammer and sweep me aside like a match stick. I was taught
to cover my head with my arms to prevent the surf board from giving me a concussion.
Eventually I learned to do a turtle roll and was able to see a bit ahead of time if a wave would be
large or small.</p>

<!--more-->




<div class='image center'><img  src="https://i.imgur.com/Lj4BEIel.jpg" width="640" height="480" title="The large suite in which I lived with my two non-Spotify friends I invited: Grace Gui and Jason Alarcon." ><div class='caption'>The large suite in which I lived with my two non-Spotify friends I invited: Grace Gui and Jason Alarcon.</div></div>


<p>After a couple of hours of surfing on an empty stomach, I would be ravenous. Our group would trudge
back to the resort where several Costa Rican women staff members had prepared a large
breakfast for us: scrambled eggs, watermelon and pineapple,
salad, rice and beans, and plantains. I&rsquo;d go back for seconds and thirds.</p>

<div class='image center'><img  src="https://i.imgur.com/QQ2zrxil.jpg" width="640" height="480" title="From left to right: Mo Tracey, Fredrik Johansson, Chris Hansen, Jeffrey Foster, David Xia, and Grace Gui." ><div class='caption'>From left to right: Mo Tracey, Fredrik Johansson, Chris Hansen, Jeffrey Foster, David Xia, and Grace Gui.</div></div>


<p>One of my colleagues Fredrik and I were pretty good beginners and had the privilege of being invited
by the instructors to a different beach at least an hour&rsquo;s drive away from the
resort. Fredrik and I rode in a taxi with one of the instructors and two other guests who were
seasoned surfers. The ride through dirt and gravel roads was bumpy and hot and all around unpleasant.
A sandless beach awaited us when we arrived. I lathered on sunscreen to protect against the intense
midday sun, took my board, and carefully walked across the seemingly endless stretch of sharp rocks
until I could mount my board and start paddling. After an hour of surfing, I remember being
exhausted but extremely grateful that I was lucky enough to experience the raw power of mother
nature in such a majestic setting. I was also extremely grateful I hadn&rsquo;t been injured so far on the
trip. The waves could be truly terrifying.</p>

<div class='image center'><img  src="https://i.imgur.com/dBL3Hw0l.jpg" width="640" height="480" title="I guess I couldn't keep my balance." ><div class='caption'>I guess I couldn&#8217;t keep my balance.</div></div>


<div class='image center'><img  src="https://i.imgur.com/EExUThOl.jpg" width="480" height="640" title="I can't remember what we were trying to do in the pool." ><div class='caption'>I can&#8217;t remember what we were trying to do in the pool.</div></div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[My First Open Water Swimming Event]]></title>
    <link href="https://www.davidxia.com/2016/07/my-first-open-water-swimming-event/"/>
    <updated>2016-07-08T22:51:51-04:00</updated>
    <id>https://www.davidxia.com/2016/07/my-first-open-water-swimming-event</id>
    <content type="html"><![CDATA[<p>I visited the southern UK with my parents last March. We visited the coast where I took a photo of the
English Channel and <a href="https://www.facebook.com/davidxia2/posts/10102320113525692">posted it on Facebook</a> with the caption,
&ldquo;I&rsquo;m looking across the English Channel now wondering if I have what it takes to swim across to
France. It&rsquo;s 21 miles across at its narrowest point and the fastest swimmer made it across in a
little over seven hours and the slowest one was 27 hours. Average water temperatures in the summer
are 14-18 degrees Celsius.&rdquo;</p>

<p>My high school swim coach Jen saw it and said, &ldquo;If you are seriously considering, let me know &mdash; I
have many friends who have done this swim (yes I hang out with weirdos)!&rdquo;. Let&rsquo;s start with
something a bit more realistic I said. Jen encouraged me to participate in the annual Wayland Three
Mile Swim which she organizes. The race takes place in Lake Cochituate, a small body of water in
Wayland, Massachusetts which borders my hometown of Wellesley.</p>

<p>So I <a href="https://www.davidxia.com/2016/04/when-routine-becomes-ritual/">trained religiously</a> for three months. A couple of days before June 19,
I took a bus from New York City back to Wellesley for the open water swim that would start at
7:30AM.</p>

<!--more-->


<p>My parents were very supportive of my endeavor and even woke up with me at 5AM to come watch.
We drove fifteen minutes to Wayland Town Beach. I met and hugged Jen and my other high school coach
Sandy both of whom I haven&rsquo;t seen in many years. We waited for a boat to setup the large
neon-colored, inflatable buoys in the lake.</p>

<p>There were twenty swimmers registered for the three mile race. I didn&rsquo;t have any expectations for
myself. I never swam continuously for such a long distance before (I was a sprinter in high school),
so my base goal was to simply finish within two hours, the maximum time allowed.</p>

<p>Summary:</p>

<ol>
<li>I did better than I thought I would. <a href="http://www.coolrunning.com/results/16/ma/Jun19_Waylan_set6.shtml">1 hour and 30 minutes.</a></li>
<li>I had my ass handed to me by 50-year-old men and teenage girls.
(Jeff Naylor, age 57, came in second place with a time of 1:05:21. Jeff, what are you on?
&#35;lifegoals)</li>
<li>I&rsquo;d definitely do it again. The water and weather were perfect. The lake tasted great.
I know because I drank half of it.</li>
</ol>


<p>Here are some photos.</p>

<div class='image center'><img  src="https://i.imgur.com/afzPLf7l.jpg" width="640" height="480" title="I pose for a photo after finishing the swim. Everything is sore." ><div class='caption'>I pose for a photo after finishing the swim. Everything is sore.</div></div>


<div class='image center'><img  src="https://i.imgur.com/prSXIsel.jpg" width="640" height="480" title="Moments before the race begins. Jeff Naylor is on my left and Sandy Smith on my right." ><div class='caption'>Moments before the race begins. Jeff Naylor is on my left and Sandy Smith on my right.</div></div>


<div class='image center'><img  src="https://i.imgur.com/Ifoh58ll.jpg" width="640" height="480" title="That's me and my kayak escort Spencer, Jen's son. I'm lucky he volunteered. I don't know who I would've had escort me otherwise." ><div class='caption'>That&#8217;s me and my kayak escort Spencer, Jen&#8217;s son. I&#8217;m lucky he volunteered. I don&#8217;t know who I would&#8217;ve had escort me otherwise.</div></div>


<div class='image center'><img  src="https://i.imgur.com/8w3OgzLl.jpg" width="640" height="480" title="Another photo of right before the start." ><div class='caption'>Another photo of right before the start.</div></div>


<div class='image center'><img  src="https://i.imgur.com/KOXM9t4l.jpg" width="583" height="470" title="Three mile race results." ><div class='caption'>Three mile race results.</div></div>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[My QCon NYC 2016 Slides - Reach Production Faster With Containers in Testing]]></title>
    <link href="https://www.davidxia.com/2016/06/my-qcon-nyc-2016-slides/"/>
    <updated>2016-06-20T17:15:49-04:00</updated>
    <id>https://www.davidxia.com/2016/06/my-qcon-nyc-2016-slides</id>
    <content type="html"><![CDATA[<p>Here are the slides from my <a href="https://qconnewyork.com/ny2016/presentation/reaching-production-faster-with-containers-in-testing">QCon NYC 2016 talk titled &ldquo;Reach Production Faster with Containers in
Testing.&rdquo;</a> in various formats. <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">All formats of &ldquo;Reach Production Faster with Containers in Testing&rdquo;</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://www.davidxia.com/2016/06/my-qcon-nyc-2016-slides-reach-production-faster-with-containers-in-testing/" property="cc:attributionName" rel="cc:attributionURL">David Xia</a> are licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>

<iframe src="//www.slideshare.net/slideshow/embed_code/key/p1uEfRmocwplbk" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>


<p> <div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/DavidXia/qcon-nyc-2016-reach-production-faster-with-containers-in-testing" title="QCon NYC 2016: Reach Production Faster with Containers in Testing" target="_blank">QCon NYC 2016: Reach Production Faster with Containers in Testing</a> </strong> from <strong><a href="//www.slideshare.net/DavidXia" target="_blank">David Xia</a></strong> </div></p>

<p>More formats here:</p>

<ul>
<li><a href="https://drive.google.com/file/d/0By_v8MtsRMKkSloyT3gxalRuYjQ/view?usp=sharing">PDF</a></li>
<li><a href="https://drive.google.com/file/d/0By_v8MtsRMKkSm9BVW5uWFR5TFk/view?usp=sharing">Keynote</a></li>
<li><a href="https://drive.google.com/file/d/0By_v8MtsRMKkRkpQWk5paUZOUW8/view?usp=sharing">PowerPoint</a></li>
</ul>


<p><img class="center" src="https://i.imgur.com/w0P47Ugl.jpg" width="640" height="619"></p>
]]></content>
  </entry>
  
</feed>
